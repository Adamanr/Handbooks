---
sidebar_position: 10
description: "Практика по оптимизации запросов: индексы, JOIN, подзапросы, агрегаты, переписывание, кэширование"
---

import { RandomVariantButton, TaskWithVariants, CodeBlockPostgres } from "../../src/components/practicModules/practic";

# Практика: Оптимизация запросов в PostgreSQL

<CodeBlockPostgres />

## Задание 1 — Индексы: от простого к сложному

<TaskWithVariants
  taskId="opt-1-indexes"
  title="Задание 1: Создание и проверка индексов"
  difficulty={["Лёгкий","Лёгкий","Лёгкий","Лёгкий","Лёгкий","Лёгкий","Лёгкий","Лёгкий","Лёгкий","Лёгкий"]}
  estimatedTime="15-30 минут"
  description="Создай индексы для ускорения типичных запросов и сравни планы."
  variants={[
    "Фильтр по стране + сортировка по дате регистрации клиентов",
    "Поиск заказов по статусу + customer_id",
    "Подсчёт заказов клиента за последние 30 дней",
    "Топ-10 самых дорогих товаров в категории",
    "Поиск продуктов по названию (LIKE 'iPhone%')",
    "Агрегация выручки по дням (GROUP BY DATE(order_date))",
    "JOIN заказов и клиентов с фильтром по сегменту",
    "Поиск отзывов по продукту + сортировка по helpful_count DESC",
    "Фильтр заказов по диапазону суммы + статусу",
    "Поиск клиентов по email (регистронезависимо)",
    "Топ-5 клиентов по суммарной выручке",
    "Подсчёт товаров на складе с ценой > 1000"
  ]}
>

**Требования:**
- выполни `EXPLAIN ANALYZE` до создания индекса
- создай подходящий индекс (простой / составной / частичный / INCLUDE)
- снова выполни `EXPLAIN ANALYZE` и сравни время / cost / тип сканирования
- напиши, какой индекс ты выбрал и почему именно такой порядок колонок

Пример ответа:
```text
До: Seq Scan, 45 ms, cost=5200
После: Index Scan on idx_orders_customer_date, 0.8 ms, cost=8.4
Индекс: CREATE INDEX idx_orders_customer_date ON orders(customer_id, order_date);
```
</TaskWithVariants>

## Задание 2 — Переписывание запросов

<TaskWithVariants
  taskId="opt-2-rewrite"
  title="Задание 2: Переписывание медленных запросов"
  difficulty={["Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний"]}
  estimatedTime="25-45 минут"
  description="Возьми неоптимальный запрос и сделай его быстрее."
  variants={[
    "SELECT * FROM customers WHERE UPPER(email) = 'TEST@GMAIL.COM'",
    "SELECT * FROM orders WHERE DATE(order_date) = '2025-02-01'",
    "SELECT * FROM products WHERE name LIKE '%iphone%' OR description LIKE '%iphone%'",
    "SELECT c.* FROM customers c WHERE id IN (SELECT customer_id FROM orders WHERE total_amount > 5000)",
    "SELECT * FROM orders WHERE status = 'delivered' OR total_amount > 10000",
    "SELECT p.name, (SELECT AVG(rating) FROM reviews WHERE product_id = p.id) FROM products p",
    "SELECT * FROM order_items WHERE quantity * unit_price > 1000 ORDER BY quantity DESC",
    "SELECT country, COUNT(*) FROM customers GROUP BY country HAVING COUNT(*) > 10000",
    "SELECT * FROM customers c LEFT JOIN orders o ON c.id = o.customer_id WHERE o.id IS NULL",
    "SELECT DISTINCT customer_id FROM orders WHERE order_date > CURRENT_DATE - INTERVAL '365 days'",
    "SELECT * FROM reviews WHERE helpful_count > (SELECT AVG(helpful_count) FROM reviews)",
    "SELECT * FROM products ORDER BY price * stock_quantity DESC LIMIT 100"
  ]}
>

**Требования:**
- запусти `EXPLAIN ANALYZE` на исходном варианте
- перепиши запрос (индексируемое выражение, JOIN вместо подзапроса, EXISTS, FILTER, диапазон вместо функции и т.д.)
- покажи новый план и прирост скорости
- обоснуй, почему стало быстрее

Пример:
```text
Исходный: Seq Scan + Filter UPPER(email), 120 ms
Переписано: Index Scan на LOWER(email), 1.2 ms
Прирост: ×100
```
</TaskWithVariants>

## Задание 3 — JOIN и подзапросы vs LATERAL / CTE

<TaskWithVariants
  taskId="opt-3-join-lateral"
  title="Задание 3: Оптимизация JOIN и подзапросов"
  difficulty={["Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний"]}
  estimatedTime="30-50 минут"
  description="Сравни разные способы соединения и агрегации."
  variants={[
    "Для каждого клиента — количество и сумма заказов за 90 дней",
    "Для каждого продукта — средний рейтинг и количество отзывов",
    "Топ-5 товаров по выручке в каждой категории",
    "Клиенты, которые сделали заказ на сумму > 10000 за всё время",
    "Продукты, у которых нет отзывов",
    "Последний заказ каждого клиента + его сумма",
    "Средний чек по странам + количество клиентов в стране",
    "Товары, купленные более 10 раз за последний месяц",
    "Клиенты без заказов за последние 180 дней",
    "Продукты с рейтингом выше среднего по категории",
    "Количество заказов по статусам за каждый месяц",
    "Клиенты, купившие хотя бы один товар из категории 'Premium'"
  ]}
>

**Требования:**
- реализуй 3–4 разных подхода к одному запросу:
  - коррелированный подзапрос
  - JOIN + GROUP BY
  - LATERAL
  - CTE / WINDOW
- сравни планы и время выполнения (`EXPLAIN ANALYZE`)
- выбери лучший вариант и обоснуй

Пример:
```sql
-- Вариант 1: коррелированный
SELECT c.*, (SELECT COUNT(*) FROM orders o WHERE o.customer_id = c.id) AS cnt
FROM customers c;

-- Вариант 2: JOIN
SELECT c.*, COUNT(o.id) AS cnt
FROM customers c LEFT JOIN orders o ON o.customer_id = c.id
GROUP BY c.id;

-- Вариант 3: LATERAL
SELECT c.*, o.cnt
FROM customers c
CROSS JOIN LATERAL (SELECT COUNT(*) AS cnt FROM orders WHERE customer_id = c.id) o;
```
</TaskWithVariants>

## Задание 4 — Агрегаты, FILTER, оконные функции

<TaskWithVariants
  taskId="opt-4-agg-window"
  title="Задание 4: Оптимизация агрегации и аналитики"
  difficulty={["Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний"]}
  estimatedTime="30-50 минут"
  description="Ускорь сложные отчёты с помощью современных конструкций."
  variants={[
    "Выручка, количество заказов, средний чек по месяцам",
    "Топ-3 товара в каждой категории по выручке",
    "Доля заказов по статусам (в % от общего)",
    "Кумулятивная выручка по дням за год",
    "Средний рейтинг товаров + количество отзывов + ранжирование по рейтингу",
    "Клиенты с покупками выше среднего чека за последние 90 дней",
    "Продукты, которые покупают вместе (простая версия)",
    "Рост выручки месяц к месяцу (%)",
    "Количество активных клиентов по сегментам",
    "Топ-10 клиентов по выручке + их доля от общей выручки",
    "Товары без продаж за последние 60 дней",
    "Скользящее среднее выручки за 7 дней"
  ]}
>

**Требования:**
- используй минимум 2–3 техники:
  - FILTER внутри агрегатов
  - оконные функции (RANK, SUM OVER, AVG OVER)
  - GROUP BY + ORDER BY
  - CTE для промежуточных вычислений
- сравни с «классическим» вариантом (множественные подзапросы)
- покажи разницу во времени и плане

Пример:
```sql
-- Классика (медленно)
SELECT category, AVG(price) FROM products GROUP BY category;

-- Современно (быстрее + информативно)
SELECT
    category,
    COUNT(*) AS total,
    AVG(price) FILTER (WHERE stock_quantity > 0) AS avg_in_stock,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY price) AS median_price
FROM products
GROUP BY category;
```
</TaskWithVariants>

## Задание 5 — Итоговый аудит и оптимизация магазина

<TaskWithVariants
  taskId="opt-5-final"
  title="Задание 5: Полный аудит и оптимизация интернет-магазина (итоговое)"
  difficulty={["Сложный","Сложный","Сложный","Сложный","Сложный","Сложный","Сложный","Сложный","Сложный","Сложный"]}
  estimatedTime="90-180 минут"
  description="Оптимизируй набор реальных запросов интернет-магазина."
  variants={[
    "Поиск товаров по категории + цене + наличию",
    "Личный кабинет: последние 10 заказов + статусы + сумма",
    "Отчёт по продажам: выручка по дням/неделям/месяцам",
    "Топ-20 товаров по выручке + количество продаж + средний рейтинг",
    "Клиенты с высоким LTV (сумма заказов > 5000)",
    "Товары без отзывов + товары с рейтингом < 3",
    "Анализ корзины: среднее количество товаров в заказе",
    "Сегментация клиентов: Premium / Standard / Basic + выручка",
    "Рекомендации: товары, которые часто покупают вместе",
    "Отчёт по доставке: среднее время от заказа до доставки по странам",
    "Мониторинг: заказы за последние 24 часа + аномалии (много отмен)",
    "Полный дашборд: ключевые метрики за день/неделю/месяц"
  ]}
>

**Требования:**
- выбери 6–8 типичных запросов из сценария
- для каждого:
  - исходный `EXPLAIN ANALYZE`
  - выявленное узкое место
  - предложенная оптимизация (индекс / переписывание / матвью / денормализация)
  - новый план + прирост скорости
- сделай 2–3 глобальные рекомендации по схеме (новые индексы, материализованные представления, триггеры, статистика)
- составь итоговый список из 8–12 рекомендаций

Это задание — полноценный кейс для собеседования на роль SQL-оптимизатора / DBA / backend-разработчика.
</TaskWithVariants>

:::tip
Оптимизация — это всегда компромисс между скоростью чтения и скоростью записи, между простотой и производительностью.  
Главное правило:  
1. Сначала измерь (EXPLAIN ANALYZE + BUFFERS)  
2. Потом оптимизируй (индексы → переписывание → кэширование)  
3. Не трогай то, что уже быстро
:::
