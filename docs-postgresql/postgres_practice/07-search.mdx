---
sidebar_position: 7
description: "Практика по полнотекстовому поиску, ts_vector, ts_query, ранжированию, подсветке и триграммам"
---

import { RandomVariantButton, TaskWithVariants, CodeBlockPostgres } from "../../src/components/practicModules/practic";

# Практика: Полнотекстовый поиск и текстовые данные

<CodeBlockPostgres />

## Задание 1 — Базовый полнотекстовый поиск

<TaskWithVariants
  taskId="search-1-basic"
  title="Задание 1: Простой поиск + tsquery + разные операторы"
  difficulty={["Лёгкий","Лёгкий","Лёгкий","Лёгкий","Лёгкий","Лёгкий","Лёгкий","Лёгкий","Лёгкий","Лёгкий"]}
  estimatedTime="15-25 минут"
  description="Создай таблицу статей/постов и напиши поисковые запросы с разными операторами."
  variants={[
    "Найти статьи, где есть 'PostgreSQL' в заголовке или содержимом",
    "Найти статьи про 'оптимизация' И 'запросы'",
    "Найти статьи про 'PostgreSQL' ИЛИ 'MySQL'",
    "Найти статьи про 'база данных' БЕЗ слова 'Oracle'",
    "Найти статьи, где фраза 'полнотекстовый поиск' идёт подряд",
    "Найти статьи, где 'индекс' и 'GIN' находятся не дальше 5 слов друг от друга",
    "Поиск по тегам с помощью массива + полнотекстовый поиск",
    "Найти статьи автора 'Мария' ИЛИ 'Алексей'",
    "Поиск с учётом морфологии: 'оптимизировать', 'оптимизация', 'оптимизировал'",
    "Поиск по websearch_to_tsquery (Google-подобный синтаксис)",
    "Искать статьи, где есть 'JSON' но НЕТ 'JSONB'",
    "Найти статьи, опубликованные после 2024 года + содержащие 'tutorial'"
  ]}
>

**Требования:**
- создай таблицу `articles` с полем `search_vector tsvector`
- хотя бы один триггер или функция для автоматического обновления tsvector
- минимум 4 разных варианта запроса (с `&`, `|`, `!`, `<->`, `<N>`)
- используй `to_tsquery`, `plainto_tsquery`, `phraseto_tsquery`, `websearch_to_tsquery`

Пример:
```sql
SELECT title, ts_rank(search_vector, query) AS rank
FROM articles, to_tsquery('russian', 'postgresql & оптимизация') query
WHERE search_vector @@ query
ORDER BY rank DESC
LIMIT 10;
```
</TaskWithVariants>

## Задание 2 — Ранжирование и подсветка

<TaskWithVariants
  taskId="search-2-ranking-headline"
  title="Задание 2: Ранжирование + ts_headline + веса"
  difficulty={["Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний"]}
  estimatedTime="20-35 минут"
  description="Добавь ранжирование и красивую подсветку результатов."
  variants={[
    "Ранжирование по ts_rank + сортировка по популярности (views_count)",
    "Ранжирование с нормализацией по длине документа (ts_rank … 1)",
    "ts_rank_cd — учитывать близость слов в запросе",
    "Комбинированный рейтинг: текстовая релевантность × log(просмотры)",
    "Учёт свежести: свежие статьи получают бонус",
    "Подсветка заголовка + первые 2 фрагмента текста",
    "ts_headline с разными параметрами (MaxFragments=3, ShortWord=4)",
    "Выделение только вхождений из заголовка (weight A)",
    "Рейтинг + % релевантности (ROUND(ts_rank * 100, 1))",
    "Сортировка сначала по рангу, потом по дате публикации DESC",
    "Подсветка с тегами <mark> и ограничением сниппета до 120 символов",
    "Ранжирование с учётом тегов (weight D для тегов)"
  ]}
>

**Требования:**
- используй `ts_rank`, `ts_rank_cd`
- хотя бы один запрос с `setweight` (A/B/C)
- минимум 2 варианта `ts_headline` с разными настройками
- красивое форматирование результата

Пример:
```sql
SELECT
    title,
    ts_headline('russian', content, query, 'StartSel=<mark>, StopSel=</mark>, MaxFragments=2') AS snippet,
    ts_rank(search_vector, query, 1) AS rank
FROM articles, websearch_to_tsquery('russian', 'postgresql индекс') query
WHERE search_vector @@ query
ORDER BY rank DESC
LIMIT 5;
```
</TaskWithVariants>

## Задание 3 — Нечёткий поиск + триграммы + Levenshtein

<TaskWithVariants
  taskId="search-3-fuzzy"
  title="Задание 3: Поиск с опечатками (pg_trgm, fuzzystrmatch)"
  difficulty={["Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний","Средний"]}
  estimatedTime="25-40 минут"
  description="Реализуй поиск, который прощает опечатки и находит похожие строки."
  variants={[
    "Поиск статей по заголовку с опечатками (LIKE '%postgre%') → триграммы",
    "Поиск похожих названий продуктов/статей (similarity > 0.4)",
    "Levenshtein ≤ 2 для заголовков",
    "Комбинация полнотекстового поиска + триграмм для заголовка",
    "Автодополнение по префиксу + нечёткое совпадение",
    "Поиск по автору с опечатками ('Мария' → 'Марияа', 'Марийя')",
    "Поиск по тегам с исправлением опечаток ('postgreql' → 'postgresql')",
    "Гибрид: полнотекст + similarity по названию",
    "Ранжирование по similarity + ts_rank",
    "Поиск SoundEx / Metaphone для русских фамилий авторов",
    "Поиск по slug с опечатками",
    "Топ-5 самых похожих статей по содержимому (ограничить длину)"
  ]}
>

**Требования:**
- установи расширения `pg_trgm` и `fuzzystrmatch`
- создай GIN-индексы с `gin_trgm_ops`
- хотя бы один запрос с `similarity()`, `levenshtein()`, `%`
- комбинированный поиск (FTS + fuzzy)

Пример:
```sql
SELECT title, similarity(title, 'Оптимизация PostgreSQL') AS sim
FROM articles
WHERE title % 'Оптимизация PostgreSQL'
   OR search_vector @@ to_tsquery('russian', 'оптимизация')
ORDER BY sim DESC
LIMIT 5;
```
</TaskWithVariants>

## Задание 4 — Продвинутые сценарии (автодополнение, многоязычность, логи)

<TaskWithVariants
  taskId="search-4-advanced"
  title="Задание 4: Автодополнение, многоязычный поиск, поиск по логам"
  difficulty={["Сложный","Сложный","Сложный","Сложный","Сложный","Сложный","Сложный","Сложный","Сложный","Сложный"]}
  estimatedTime="40-70 минут"
  description="Реализуй реальные поисковые фичи."
  variants={[
    "Автодополнение поисковых запросов (как в Google/Yandex)",
    "Логирование и топ популярных запросов",
    "Многоязычный поиск (русский + английский в одной таблице)",
    "Поиск по логам ошибок с выделением ключевых слов",
    "Поиск документов (PDF, Word) по извлечённому тексту",
    "Поиск + фильтр по дате, автору, тегам",
    "Поиск с учётом синонимов (postgres = postgresql = pgsql)",
    "Поиск ближайших по смыслу статей (триграммы + FTS)",
    "Поиск с весами: заголовок > первые 200 символов > остальной текст",
    "Поиск по хэштегам + полнотекст по содержимому",
    "Реализация функции search_posts(search_text, limit, offset, min_rank)",
    "Поиск + пагинация + общее количество найденных записей"
  ]}
>

**Требования:**
- функция поиска с параметрами (query, limit, offset, filters…)
- минимум один сценарий с автодополнением
- хотя бы один многоязычный пример или синонимы
- красивая функция + комментарии

Пример структуры функции:
```sql
CREATE FUNCTION search_articles(
    q TEXT,
    lim INT DEFAULT 10,
    offs INT DEFAULT 0
) RETURNS TABLE(...) AS $$
...
$$ LANGUAGE sql STABLE;
```
</TaskWithVariants>

## Задание 5 — Итоговый поисковый движок

<TaskWithVariants
  taskId="search-5-final"
  title="Задание 5: Полноценная поисковая система (итоговое)"
  difficulty={["Сложный","Сложный","Сложный","Сложный","Сложный","Сложный","Сложный","Сложный","Сложный","Сложный"]}
  estimatedTime="90-180 минут"
  description="Создай мини-поисковик уровня блога / магазина / документации."
  variants={[
    "Поиск по статьям блога (заголовок, текст, теги, автор)",
    "Поиск товаров в интернет-магазине (название, описание, характеристики)",
    "Поиск по документации / тех. статьям (многоязычный)",
    "Поиск по логам приложения (ошибки, предупреждения, запросы)",
    "Поиск по форуму / комментариям (пост + ответы)",
    "Поиск по резюме / вакансиям (навыки, опыт, ключевые слова)",
    "Поиск по email-рассылке / письмам (тема + тело)",
    "Поиск по чату / переписке (сообщения + участники)",
    "Поиск по юридическим документам (договоры, акты)",
    "Поиск по новостям (заголовок + лид + теги + дата)",
    "Универсальный поиск по смешанным данным (статьи + товары + пользователи)",
    "Поиск + персонализация (учёт просмотров / лайков / истории поиска)"
  ]}
>

**Требования:**
- полноценная таблица + tsvector + GIN-индекс
- триггер для обновления search_vector
- функция поиска с ранжированием, подсветкой, пагинацией
- поддержка весов, синонимов, опечаток, фраз
- логирование запросов + автодополнение (бонус)
- красивая выдача: заголовок, сниппет, релевантность, метаданные

Это задание — отличный проект для портфолио или собеседования на позицию SQL-разработчика / аналитика / бэкендера.
</TaskWithVariants>

:::tip
Полнотекстовый поиск — это когда ты перестаёшь писать 15 условий LIKE и начинаешь думать как поисковая система.  
Главные правила успеха:
1. Отдельная колонка tsvector + GIN-индекс — обязательно
2. websearch_to_tsquery — лучший друг пользовательского ввода
3. ts_headline — делает результаты красивыми и понятными
4. ts_rank + веса + нормализация = релевантные результаты
5. pg_trgm + levenshtein = прощение опечаток
:::
