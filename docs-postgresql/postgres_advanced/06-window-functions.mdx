---
id: module-06-windows-functions
title: "–û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ"
sidebar_label: "–û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏"
sidebar_position: 6
description: "–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ–∫–æ–Ω–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º, –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –∏ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—é"
keywords: [postgresql, window_functions]
---

import { CodeBlockGoPostgres } from "../../src/components/practicModules/practic";

# –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (Window Functions): –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ

## –í–≤–µ–¥–µ–Ω–∏–µ

–û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (Window Functions) ‚Äî —ç—Ç–æ –æ–¥–Ω–∞ –∏–∑ —Å–∞–º—ã—Ö –º–æ—â–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π SQL –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –û–Ω–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞–¥ –Ω–∞–±–æ—Ä–æ–º —Å—Ç—Ä–æ–∫, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–æ–π, –Ω–µ –≥—Ä—É–ø–ø–∏—Ä—É—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç GROUP BY. –≠—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è, –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤, —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Ç–æ–≥–æ–≤ –∏ –º–Ω–æ–≥–æ–≥–æ –¥—Ä—É–≥–æ–≥–æ.

<CodeBlockGoPostgres />

## –ß—Ç–æ —Ç–∞–∫–æ–µ –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏?

### –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

**–û–∫–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è** –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –¥–ª—è –Ω–∞–±–æ—Ä–∞ —Å—Ç—Ä–æ–∫ (–Ω–∞–∑—ã–≤–∞–µ–º–æ–≥–æ "–æ–∫–Ω–æ–º"), —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ —Å —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–æ–π, –Ω–æ –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç GROUP BY:
- **–ù–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç** —Å—Ç—Ä–æ–∫–∏ –≤ –≥—Ä—É–ø–ø—ã
- **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç** –≤—Å–µ –∏—Å—Ö–æ–¥–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
- **–î–æ–±–∞–≤–ª—è–µ—Ç** –≤—ã—á–∏—Å–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ

```sql
-- GROUP BY ‚Äî —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏
SELECT 
    department,
    AVG(salary) as avg_salary
FROM employees
GROUP BY department;
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 3 —Å—Ç—Ä–æ–∫–∏ (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ –æ—Ç–¥–µ–ª)

-- Window Function ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏
SELECT 
    name,
    department,
    salary,
    AVG(salary) OVER (PARTITION BY department) as dept_avg_salary
FROM employees;
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 100 —Å—Ç—Ä–æ–∫ (–≤—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º —Å—Ä–µ–¥–Ω–∏–º –ø–æ –æ—Ç–¥–µ–ª—É)
```

### –ë–∞–∑–æ–≤—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å

```sql
function_name([arguments]) OVER (
    [PARTITION BY partition_expression]
    [ORDER BY sort_expression [ASC | DESC]]
    [frame_clause]
)
```

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- **function_name** ‚Äî –æ–∫–æ–Ω–Ω–∞—è –∏–ª–∏ –∞–≥—Ä–µ–≥–∞—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
- **PARTITION BY** ‚Äî —Ä–∞–∑–¥–µ–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≥—Ä—É–ø–ø—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **ORDER BY** ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–æ–∫ –≤ –æ–∫–Ω–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **frame_clause** ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞–º–∫–∏ –æ–∫–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞–¥–∏–º —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏.

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
CREATE DATABASE analytics_demo;

-- –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
CREATE TABLE employees (
    employee_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    department VARCHAR(50) NOT NULL,
    position VARCHAR(50),
    salary NUMERIC(10, 2) NOT NULL,
    hire_date DATE NOT NULL,
    manager_id INTEGER REFERENCES employees(employee_id)
);

-- –ü—Ä–æ–¥—É–∫—Ç—ã
CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    product_name VARCHAR(200) NOT NULL,
    category VARCHAR(50) NOT NULL,
    price NUMERIC(10, 2) NOT NULL,
    cost NUMERIC(10, 2) NOT NULL,
    launch_date DATE
);

-- –ü—Ä–æ–¥–∞–∂–∏
CREATE TABLE sales (
    sale_id SERIAL PRIMARY KEY,
    product_id INTEGER REFERENCES products(product_id),
    employee_id INTEGER REFERENCES employees(employee_id),
    sale_date DATE NOT NULL,
    quantity INTEGER NOT NULL,
    unit_price NUMERIC(10, 2) NOT NULL,
    discount_percent NUMERIC(5, 2) DEFAULT 0,
    region VARCHAR(50)
);

-- –í—Å—Ç–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
INSERT INTO employees (name, department, position, salary, hire_date, manager_id) VALUES
    ('–ê–ª–µ–∫—Å–µ–π –ò–≤–∞–Ω–æ–≤', 'IT', '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', 120000, '2020-01-15', NULL),
    ('–ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞', 'IT', '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', 115000, '2020-03-20', 1),
    ('–°–µ—Ä–≥–µ–π –°–º–∏—Ä–Ω–æ–≤', 'IT', 'Junior —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', 80000, '2022-05-10', 1),
    ('–ï–ª–µ–Ω–∞ –ö–æ–∑–ª–æ–≤–∞', 'Sales', '–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º', 95000, '2019-08-01', NULL),
    ('–î–º–∏—Ç—Ä–∏–π –í–æ–ª–∫–æ–≤', 'Sales', '–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º', 90000, '2020-11-15', 4),
    ('–û–ª—å–≥–∞ –ú–æ—Ä–æ–∑–æ–≤–∞', 'Sales', 'Junior –º–µ–Ω–µ–¥–∂–µ—Ä', 65000, '2023-02-01', 4),
    ('–ò–≤–∞–Ω –ù–æ–≤–∏–∫–æ–≤', 'HR', 'HR —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç', 75000, '2021-04-10', NULL),
    ('–ê–Ω–Ω–∞ –°–æ–∫–æ–ª–æ–≤–∞', 'HR', '–†–µ–∫—Ä—É—Ç–µ—Ä', 70000, '2021-09-20', 7),
    ('–ü–µ—Ç—Ä –õ–µ–±–µ–¥–µ–≤', 'Marketing', '–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥', 85000, '2020-06-15', NULL),
    ('–ù–∞—Ç–∞–ª—å—è –ü–∞–≤–ª–æ–≤–∞', 'Marketing', 'SMM —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç', 72000, '2022-01-10', 9);

INSERT INTO products (product_name, category, price, cost, launch_date) VALUES
    ('–ù–æ—É—Ç–±—É–∫ Pro 15', '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', 85000, 65000, '2023-01-10'),
    ('–°–º–∞—Ä—Ç—Ñ–æ–Ω X12', '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', 45000, 32000, '2023-02-15'),
    ('–ù–∞—É—à–Ω–∏–∫–∏ Premium', '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã', 8000, 4500, '2023-03-01'),
    ('–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è', '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã', 5500, 3000, '2023-01-20'),
    ('–ú—ã—à—å –±–µ—Å–ø—Ä–æ–≤–æ–¥–Ω–∞—è', '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã', 2500, 1200, '2023-02-01'),
    ('–ú–æ–Ω–∏—Ç–æ—Ä 27"', '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', 35000, 25000, '2023-04-01'),
    ('–ü–ª–∞–Ω—à–µ—Ç Tab 10', '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', 28000, 20000, '2023-05-15'),
    ('–ö–∞–±–µ–ª—å USB-C', '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã', 800, 300, '2023-01-05'),
    ('–ß–µ—Ö–æ–ª –¥–ª—è –Ω–æ—É—Ç–±—É–∫–∞', '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã', 1500, 600, '2023-02-20'),
    ('–í–µ–±-–∫–∞–º–µ—Ä–∞ HD', '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã', 4500, 2500, '2023-03-10');

-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–∞–∂ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤
INSERT INTO sales (product_id, employee_id, sale_date, quantity, unit_price, discount_percent, region)
SELECT 
    (random() * 9 + 1)::INTEGER,
    (random() * 5 + 4)::INTEGER,  -- –¢–æ–ª—å–∫–æ sales —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (4-6)
    CURRENT_DATE - (random() * 180)::INTEGER,
    (random() * 5 + 1)::INTEGER,
    p.price * (1 - random() * 0.2),  -- –¶–µ–Ω–∞ —Å –≤–∞—Ä–∏–∞—Ü–∏–µ–π
    (random() * 20)::NUMERIC(5,2),
    CASE (random() * 3)::INTEGER
        WHEN 0 THEN '–ú–æ—Å–∫–≤–∞'
        WHEN 1 THEN '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥'
        WHEN 2 THEN '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥'
        ELSE '–ö–∞–∑–∞–Ω—å'
    END
FROM generate_series(1, 200) AS gs
CROSS JOIN products p
WHERE p.product_id = (random() * 9 + 1)::INTEGER
LIMIT 200;

-- –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
CREATE INDEX idx_sales_date ON sales(sale_date);
CREATE INDEX idx_sales_product ON sales(product_id);
CREATE INDEX idx_sales_employee ON sales(employee_id);
```

## –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è

### ROW_NUMBER() ‚Äî –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –Ω—É–º–µ—Ä–∞—Ü–∏—è

`ROW_NUMBER()` –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ –≤ –æ–∫–Ω–µ.

```sql
-- –ü—Ä–æ—Å—Ç–∞—è –Ω—É–º–µ—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
SELECT 
    ROW_NUMBER() OVER (ORDER BY salary DESC) AS rank,
    name,
    department,
    salary
FROM employees
ORDER BY rank;

-- –ù—É–º–µ—Ä–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–¥–µ–ª–∞
SELECT 
    department,
    name,
    salary,
    ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) AS dept_rank
FROM employees
ORDER BY department, dept_rank;

-- –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –ø–∞–≥–∏–Ω–∞—Ü–∏—è
SELECT 
    ROW_NUMBER() OVER (ORDER BY sale_date DESC) AS row_num,
    sale_id,
    sale_date,
    quantity * unit_price AS total
FROM sales
WHERE ROW_NUMBER() OVER (ORDER BY sale_date DESC) BETWEEN 11 AND 20;

-- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è (—Å –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–º)
SELECT * FROM (
    SELECT 
        ROW_NUMBER() OVER (ORDER BY sale_date DESC) AS row_num,
        sale_id,
        sale_date,
        quantity * unit_price AS total
    FROM sales
) AS numbered
WHERE row_num BETWEEN 11 AND 20;
```

:::tip –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ROW_NUMBER
- –ù—É–∂–Ω–∞ **—É–Ω–∏–∫–∞–ª—å–Ω–∞—è –Ω—É–º–µ—Ä–∞—Ü–∏—è** –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è **–ø–∞–≥–∏–Ω–∞—Ü–∏–∏**
- –í—ã–±–æ—Ä **–ø–µ—Ä–≤—ã—Ö N –∑–∞–ø–∏—Å–µ–π** –≤ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
:::

### RANK() ‚Äî –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏

`RANK()` –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç —Ä–∞–Ω–≥ —Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏ –ø—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö.

```sql
-- –ë–∞–∑–æ–≤–æ–µ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ
SELECT 
    name,
    department,
    salary,
    RANK() OVER (ORDER BY salary DESC) AS salary_rank
FROM employees
ORDER BY salary_rank;

-- –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –æ—Ç–¥–µ–ª–æ–≤
SELECT 
    department,
    name,
    salary,
    RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS dept_rank
FROM employees
ORDER BY department, dept_rank;

-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ ROW_NUMBER –∏ RANK
SELECT 
    name,
    salary,
    ROW_NUMBER() OVER (ORDER BY salary DESC) AS row_num,
    RANK() OVER (ORDER BY salary DESC) AS rank_num
FROM employees
ORDER BY salary DESC;
/*
–ï—Å–ª–∏ –¥–≤–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–º–µ—é—Ç –∑–∞—Ä–ø–ª–∞—Ç—É 90000:
ROW_NUMBER: 4, 5 (—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞)
RANK: 4, 4 (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–∞–Ω–≥, —Å–ª–µ–¥—É—é—â–∏–π –±—É–¥–µ—Ç 6)
*/

-- –¢–æ–ø-3 –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
WITH product_sales AS (
    SELECT 
        p.product_id,
        p.product_name,
        p.category,
        SUM(s.quantity * s.unit_price) AS total_revenue,
        COUNT(*) AS sales_count
    FROM products p
    LEFT JOIN sales s ON p.product_id = s.product_id
    GROUP BY p.product_id, p.product_name, p.category
)
SELECT 
    category,
    product_name,
    total_revenue,
    sales_count,
    RANK() OVER (PARTITION BY category ORDER BY total_revenue DESC) AS category_rank
FROM product_sales
WHERE RANK() OVER (PARTITION BY category ORDER BY total_revenue DESC) <= 3
ORDER BY category, category_rank;
```

### DENSE_RANK() ‚Äî –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤

`DENSE_RANK()` –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç —Ä–∞–Ω–≥ –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –ø—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö.

```sql
-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç—Ä–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è
SELECT 
    name,
    salary,
    ROW_NUMBER() OVER (ORDER BY salary DESC) AS row_number,
    RANK() OVER (ORDER BY salary DESC) AS rank,
    DENSE_RANK() OVER (ORDER BY salary DESC) AS dense_rank
FROM employees
ORDER BY salary DESC;

/*
–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
name            salary   row_number  rank  dense_rank
–ê–ª–µ–∫—Å–µ–π –ò–≤–∞–Ω–æ–≤  120000   1          1     1
–ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞   115000   2          2     2
–ï–ª–µ–Ω–∞ –ö–æ–∑–ª–æ–≤–∞   95000    3          3     3
–î–º–∏—Ç—Ä–∏–π –í–æ–ª–∫–æ–≤  90000    4          4     4
–î–º–∏—Ç—Ä–∏–π –í–æ–ª–∫–æ–≤  90000    5          4     4  <- RANK –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç 5
–ü–µ—Ç—Ä –õ–µ–±–µ–¥–µ–≤    85000    6          6     5  <- DENSE_RANK –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç
*/

-- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞—Ä–ø–ª–∞—Ç—ã
SELECT 
    name,
    department,
    salary,
    DENSE_RANK() OVER (ORDER BY salary DESC) AS salary_tier,
    CASE 
        WHEN DENSE_RANK() OVER (ORDER BY salary DESC) <= 3 THEN '–í—ã—Å–æ–∫–∞—è'
        WHEN DENSE_RANK() OVER (ORDER BY salary DESC) <= 6 THEN '–°—Ä–µ–¥–Ω—è—è'
        ELSE '–ù–∏–∑–∫–∞—è'
    END AS salary_category
FROM employees
ORDER BY salary DESC;

-- –ú–µ–¥–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ–¥–∞–≤—Ü–æ–≤
WITH monthly_sales AS (
    SELECT 
        e.employee_id,
        e.name,
        DATE_TRUNC('month', s.sale_date) AS month,
        SUM(s.quantity * s.unit_price) AS total_revenue
    FROM employees e
    JOIN sales s ON e.employee_id = s.employee_id
    WHERE e.department = 'Sales'
    GROUP BY e.employee_id, e.name, DATE_TRUNC('month', s.sale_date)
)
SELECT 
    month,
    name,
    total_revenue,
    DENSE_RANK() OVER (PARTITION BY month ORDER BY total_revenue DESC) AS rank,
    CASE DENSE_RANK() OVER (PARTITION BY month ORDER BY total_revenue DESC)
        WHEN 1 THEN 'ü•á –ó–æ–ª–æ—Ç–æ'
        WHEN 2 THEN 'ü•à –°–µ—Ä–µ–±—Ä–æ'
        WHEN 3 THEN 'ü•â –ë—Ä–æ–Ω–∑–∞'
        ELSE '   -'
    END AS medal
FROM monthly_sales
ORDER BY month DESC, rank;
```

:::info –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É RANK –∏ DENSE_RANK
- **RANK()**: 1, 2, 2, **4**, 5 (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç 3)
- **DENSE_RANK()**: 1, 2, 2, **3**, 4 (–Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç)

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ DENSE_RANK –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –Ω—É–º–µ—Ä–∞—Ü–∏—è —É—Ä–æ–≤–Ω–µ–π.
:::

### NTILE() ‚Äî –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –≥—Ä—É–ø–ø—ã

`NTILE(n)` –¥–µ–ª–∏—Ç —Å—Ç—Ä–æ–∫–∏ –Ω–∞ n –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–≤–Ω—ã—Ö –≥—Ä—É–ø–ø.

```sql
-- –†–∞–∑–¥–µ–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ 4 –∫–≤–∞—Ä—Ç–∏–ª—è –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–µ
SELECT 
    name,
    department,
    salary,
    NTILE(4) OVER (ORDER BY salary DESC) AS salary_quartile,
    CASE NTILE(4) OVER (ORDER BY salary DESC)
        WHEN 1 THEN '–¢–æ–ø 25%'
        WHEN 2 THEN '25-50%'
        WHEN 3 THEN '50-75%'
        WHEN 4 THEN '–ù–∏–∑—à–∏–µ 25%'
    END AS quartile_label
FROM employees
ORDER BY salary DESC;

-- ABC –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É –ü–∞—Ä–µ—Ç–æ)
WITH product_revenue AS (
    SELECT 
        p.product_id,
        p.product_name,
        SUM(s.quantity * s.unit_price) AS total_revenue,
        SUM(s.quantity) AS total_quantity
    FROM products p
    LEFT JOIN sales s ON p.product_id = s.product_id
    GROUP BY p.product_id, p.product_name
)
SELECT 
    product_name,
    total_revenue,
    total_quantity,
    NTILE(3) OVER (ORDER BY total_revenue DESC) AS revenue_tier,
    CASE NTILE(3) OVER (ORDER BY total_revenue DESC)
        WHEN 1 THEN 'A - –ö–ª—é—á–µ–≤—ã–µ (—Ç–æ–ø 33%)'
        WHEN 2 THEN 'B - –í–∞–∂–Ω—ã–µ (—Å—Ä–µ–¥–Ω–∏–µ 33%)'
        WHEN 3 THEN 'C - –ü—Ä–æ—á–∏–µ (–Ω–∏–∂–Ω–∏–µ 33%)'
    END AS abc_category
FROM product_revenue
ORDER BY total_revenue DESC;

-- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂ –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –ø–µ—Ä–∏–æ–¥–∞–º –Ω–∞ –≥—Ä—É–ø–ø—ã
SELECT 
    sale_date,
    sale_id,
    quantity * unit_price AS revenue,
    NTILE(10) OVER (ORDER BY sale_date) AS time_decile
FROM sales
ORDER BY sale_date;

-- –°–æ–∑–¥–∞–Ω–∏–µ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
SELECT 
    name,
    salary,
    NTILE(3) OVER (PARTITION BY department ORDER BY salary DESC) AS team_number
FROM employees
ORDER BY department, team_number;
```

## –§—É–Ω–∫—Ü–∏–∏ —Å–º–µ—â–µ–Ω–∏—è (Offset Functions)

### LAG() ‚Äî –ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

`LAG()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ –≤ –æ–∫–Ω–µ.

```sql
-- –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ LAG
SELECT 
    sale_date,
    SUM(quantity * unit_price) AS daily_revenue,
    LAG(SUM(quantity * unit_price)) OVER (ORDER BY sale_date) AS prev_day_revenue
FROM sales
GROUP BY sale_date
ORDER BY sale_date;

-- –†–∞—Å—á–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è
SELECT 
    sale_date,
    daily_revenue,
    prev_day_revenue,
    daily_revenue - prev_day_revenue AS revenue_change,
    ROUND(
        (daily_revenue - prev_day_revenue) / NULLIF(prev_day_revenue, 0) * 100,
        2
    ) AS percent_change
FROM (
    SELECT 
        sale_date,
        SUM(quantity * unit_price) AS daily_revenue,
        LAG(SUM(quantity * unit_price)) OVER (ORDER BY sale_date) AS prev_day_revenue
    FROM sales
    GROUP BY sale_date
) AS daily_stats
ORDER BY sale_date DESC
LIMIT 30;

-- LAG —Å PARTITION BY ‚Äî –ø—Ä–µ–¥—ã–¥—É—â–∞—è –ø—Ä–æ–¥–∞–∂–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
SELECT 
    p.product_name,
    s.sale_date,
    s.quantity * s.unit_price AS revenue,
    LAG(s.sale_date) OVER (PARTITION BY s.product_id ORDER BY s.sale_date) AS prev_sale_date,
    LAG(s.quantity * s.unit_price) OVER (PARTITION BY s.product_id ORDER BY s.sale_date) AS prev_revenue,
    s.sale_date - LAG(s.sale_date) OVER (PARTITION BY s.product_id ORDER BY s.sale_date) AS days_since_last_sale
FROM sales s
JOIN products p ON s.product_id = p.product_id
ORDER BY p.product_name, s.sale_date DESC;

-- LAG —Å offset –∏ default –∑–Ω–∞—á–µ–Ω–∏–µ–º
SELECT 
    name,
    hire_date,
    salary,
    -- –ü—Ä–µ–¥—ã–¥—É—â–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞ (offset = 1, default = 0)
    LAG(salary, 1, 0) OVER (PARTITION BY department ORDER BY hire_date) AS prev_salary,
    -- –ó–∞—Ä–ø–ª–∞—Ç–∞ 2 –Ω–∞–π–º–∞ –Ω–∞–∑–∞–¥ (offset = 2)
    LAG(salary, 2) OVER (PARTITION BY department ORDER BY hire_date) AS salary_2_hires_ago
FROM employees
ORDER BY department, hire_date;
```

### LEAD() ‚Äî –°–ª–µ–¥—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

`LEAD()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–∏ –≤ –æ–∫–Ω–µ.

```sql
-- –ü—Ä–æ–≥–Ω–æ–∑: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –±—É–¥—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
SELECT 
    sale_date,
    daily_revenue,
    LEAD(daily_revenue) OVER (ORDER BY sale_date) AS next_day_revenue,
    LEAD(daily_revenue, 7) OVER (ORDER BY sale_date) AS same_day_next_week
FROM (
    SELECT 
        sale_date,
        SUM(quantity * unit_price) AS daily_revenue
    FROM sales
    GROUP BY sale_date
) AS daily
ORDER BY sale_date;

-- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞ (—Ä–∞—Å—Ç–µ—Ç/–ø–∞–¥–∞–µ—Ç)
SELECT 
    sale_date,
    daily_revenue,
    LAG(daily_revenue) OVER (ORDER BY sale_date) AS yesterday,
    LEAD(daily_revenue) OVER (ORDER BY sale_date) AS tomorrow,
    CASE 
        WHEN daily_revenue > LAG(daily_revenue) OVER (ORDER BY sale_date)
         AND daily_revenue > LEAD(daily_revenue) OVER (ORDER BY sale_date) 
        THEN '–ü–∏–∫'
        WHEN daily_revenue < LAG(daily_revenue) OVER (ORDER BY sale_date)
         AND daily_revenue < LEAD(daily_revenue) OVER (ORDER BY sale_date)
        THEN '–°–ø–∞–¥'
        WHEN daily_revenue > LAG(daily_revenue) OVER (ORDER BY sale_date) 
        THEN '–†–æ—Å—Ç'
        WHEN daily_revenue < LAG(daily_revenue) OVER (ORDER BY sale_date)
        THEN '–°–Ω–∏–∂–µ–Ω–∏–µ'
        ELSE '–°—Ç–∞–±–∏–ª—å–Ω–æ'
    END AS trend
FROM (
    SELECT 
        sale_date,
        SUM(quantity * unit_price) AS daily_revenue
    FROM sales
    GROUP BY sale_date
) AS daily
ORDER BY sale_date DESC;

-- –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –º–µ–∂–¥—É —Å–æ–±—ã—Ç–∏—è–º–∏
SELECT 
    employee_id,
    sale_date,
    LEAD(sale_date) OVER (PARTITION BY employee_id ORDER BY sale_date) AS next_sale_date,
    LEAD(sale_date) OVER (PARTITION BY employee_id ORDER BY sale_date) - sale_date AS days_to_next_sale,
    AVG(LEAD(sale_date) OVER (PARTITION BY employee_id ORDER BY sale_date) - sale_date) 
        OVER (PARTITION BY employee_id) AS avg_days_between_sales
FROM sales
ORDER BY employee_id, sale_date;
```

### FIRST_VALUE() –∏ LAST_VALUE()

```sql
-- FIRST_VALUE ‚Äî –ø–µ—Ä–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –æ–∫–Ω–µ
SELECT 
    name,
    department,
    salary,
    FIRST_VALUE(name) OVER (
        PARTITION BY department 
        ORDER BY salary DESC
    ) AS highest_paid_in_dept,
    FIRST_VALUE(salary) OVER (
        PARTITION BY department 
        ORDER BY salary DESC
    ) AS top_salary_in_dept,
    salary - FIRST_VALUE(salary) OVER (
        PARTITION BY department 
        ORDER BY salary DESC
    ) AS salary_gap
FROM employees
ORDER BY department, salary DESC;

-- LAST_VALUE ‚Äî –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—Ç—Ä–µ–±—É–µ—Ç frame clause!)
SELECT 
    name,
    department,
    hire_date,
    LAST_VALUE(name) OVER (
        PARTITION BY department 
        ORDER BY hire_date
        ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS newest_hire_in_dept
FROM employees
ORDER BY department, hire_date;

-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø–µ—Ä–≤–æ–π –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–¥–∞–∂–µ–π
SELECT 
    p.product_name,
    s.sale_date,
    s.quantity * s.unit_price AS revenue,
    FIRST_VALUE(s.sale_date) OVER (
        PARTITION BY s.product_id 
        ORDER BY s.sale_date
    ) AS first_sale_date,
    LAST_VALUE(s.sale_date) OVER (
        PARTITION BY s.product_id 
        ORDER BY s.sale_date
        ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS last_sale_date
FROM sales s
JOIN products p ON s.product_id = p.product_id
ORDER BY p.product_name, s.sale_date;

-- –î–∏–Ω–∞–º–∏–∫–∞ —Ü–µ–Ω—ã: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π —Ü–µ–Ω–æ–π
SELECT 
    product_id,
    sale_date,
    unit_price,
    FIRST_VALUE(unit_price) OVER (
        PARTITION BY product_id 
        ORDER BY sale_date
    ) AS initial_price,
    ROUND(
        (unit_price - FIRST_VALUE(unit_price) OVER (
            PARTITION BY product_id 
            ORDER BY sale_date
        )) / FIRST_VALUE(unit_price) OVER (
            PARTITION BY product_id 
            ORDER BY sale_date
        ) * 100,
        2
    ) AS price_change_percent
FROM sales
ORDER BY product_id, sale_date;
```

:::warning LAST_VALUE –∏ Frame Clause
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é `LAST_VALUE` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç frame `RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW`, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç "–æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏". –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–æ –≤—Å–µ–º –æ–∫–Ω–µ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
```sql
ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
```
:::

### NTH_VALUE() ‚Äî N-–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

```sql
-- –ü–æ–ª—É—á–∏—Ç—å 2-—É—é —Å–∞–º—É—é –≤—ã—Å–æ–∫—É—é –∑–∞—Ä–ø–ª–∞—Ç—É –≤ –∫–∞–∂–¥–æ–º –æ—Ç–¥–µ–ª–µ
SELECT DISTINCT
    department,
    NTH_VALUE(salary, 1) OVER (
        PARTITION BY department 
        ORDER BY salary DESC
        ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS highest_salary,
    NTH_VALUE(salary, 2) OVER (
        PARTITION BY department 
        ORDER BY salary DESC
        ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS second_highest_salary,
    NTH_VALUE(salary, 3) OVER (
        PARTITION BY department 
        ORDER BY salary DESC
        ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS third_highest_salary
FROM employees
ORDER BY department;

-- –ú–µ–¥–∏–∞–Ω–∞ —á–µ—Ä–µ–∑ NTH_VALUE
WITH ranked AS (
    SELECT 
        department,
        salary,
        ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary) AS rn,
        COUNT(*) OVER (PARTITION BY department) AS cnt
    FROM employees
)
SELECT DISTINCT
    department,
    NTH_VALUE(salary, (cnt + 1) / 2) OVER (
        PARTITION BY department 
        ORDER BY salary
        ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS median_salary
FROM ranked;
```

## –ê–≥—Ä–µ–≥–∞—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞–∫ –æ–∫–æ–Ω–Ω—ã–µ

### SUM() OVER ‚Äî –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Ç–æ–≥–∏

```sql
-- Running Total (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞)
SELECT 
    sale_date,
    SUM(quantity * unit_price) AS daily_revenue,
    SUM(SUM(quantity * unit_price)) OVER (
        ORDER BY sale_date
    ) AS cumulative_revenue
FROM sales
GROUP BY sale_date
ORDER BY sale_date;

-- –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º
SELECT 
    p.product_name,
    s.sale_date,
    s.quantity * s.unit_price AS sale_amount,
    SUM(s.quantity * s.unit_price) OVER (
        PARTITION BY s.product_id 
        ORDER BY s.sale_date
    ) AS product_cumulative_revenue
FROM sales s
JOIN products p ON s.product_id = p.product_id
ORDER BY p.product_name, s.sale_date;

-- –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏—Ç–æ–≥–∞
WITH daily_sales AS (
    SELECT 
        sale_date,
        SUM(quantity * unit_price) AS daily_revenue
    FROM sales
    GROUP BY sale_date
),
cumulative AS (
    SELECT 
        sale_date,
        daily_revenue,
        SUM(daily_revenue) OVER (ORDER BY sale_date) AS cumulative_revenue,
        SUM(daily_revenue) OVER () AS total_revenue
    FROM daily_sales
)
SELECT 
    sale_date,
    daily_revenue,
    cumulative_revenue,
    ROUND(cumulative_revenue / total_revenue * 100, 2) AS percent_of_total
FROM cumulative
ORDER BY sale_date;
```

### AVG() OVER ‚Äî –°–∫–æ–ª—å–∑—è—â–∏–µ —Å—Ä–µ–¥–Ω–∏–µ

```sql
-- –ü—Ä–æ—Å—Ç–æ–µ —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ (Moving Average)
SELECT 
    sale_date,
    daily_revenue,
    -- –°—Ä–µ–¥–Ω–µ–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
    ROUND(AVG(daily_revenue) OVER (
        ORDER BY sale_date
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
    ), 2) AS moving_avg_7d,
    -- –°—Ä–µ–¥–Ω–µ–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
    ROUND(AVG(daily_revenue) OVER (
        ORDER BY sale_date
        ROWS BETWEEN 29 PRECEDING AND CURRENT ROW
    ), 2) AS moving_avg_30d
FROM (
    SELECT 
        sale_date,
        SUM(quantity * unit_price) AS daily_revenue
    FROM sales
    GROUP BY sale_date
) AS daily
ORDER BY sale_date DESC;

-- –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ
SELECT 
    sale_date,
    daily_revenue,
    ROUND(AVG(daily_revenue) OVER (
        ORDER BY sale_date
        ROWS BETWEEN 3 PRECEDING AND 3 FOLLOWING
    ), 2) AS centered_moving_avg_7d
FROM (
    SELECT 
        sale_date,
        SUM(quantity * unit_price) AS daily_revenue
    FROM sales
    GROUP BY sale_date
) AS daily
ORDER BY sale_date;

-- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ (EMA) ‚Äî –ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω–æ
WITH daily_revenue AS (
    SELECT 
        sale_date,
        SUM(quantity * unit_price) AS revenue
    FROM sales
    GROUP BY sale_date
    ORDER BY sale_date
),
ema_calc AS (
    SELECT 
        sale_date,
        revenue,
        ROW_NUMBER() OVER (ORDER BY sale_date) AS rn,
        -- –ü—Ä–æ—Å—Ç–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –ø–µ—Ä–≤—ã—Ö 10 –¥–Ω–µ–π –∫–∞–∫ –Ω–∞—á–∞–ª—å–Ω–æ–µ EMA
        CASE 
            WHEN ROW_NUMBER() OVER (ORDER BY sale_date) <= 10 
            THEN AVG(revenue) OVER (
                ORDER BY sale_date 
                ROWS BETWEEN 9 PRECEDING AND CURRENT ROW
            )
            ELSE NULL
        END AS initial_ema
    FROM daily_revenue
)
