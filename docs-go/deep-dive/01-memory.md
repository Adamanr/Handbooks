---
sidebar_position: 1
---

# Memory Model ะธ Stack/Heap

## ะะฒะตะดะตะฝะธะต

ะัะตะดััะฐะฒััะต ะดะฒะฐ ัะฟะพัะพะฑะฐ ััะฐะฝะตะฝะธั ะฒะตัะตะน:

**ะกัะพะฟะบะฐ ัะฐัะตะปะพะบ (Stack)** โ ะฒั ะบะปะฐะดะตัะต ัะฐัะตะปะบะธ ะพะดะฝั ะฝะฐ ะดััะณัั. ะะทััั ะผะพะถะฝะพ ัะพะปัะบะพ ะฒะตััะฝัั. ะััััะพ, ะฟัะพััะพ, ะฝะพ ะพะณัะฐะฝะธัะตะฝะพ.

**ะกะบะปะฐะด (Heap)** โ ะพะณัะพะผะฝะพะต ะฟะพะผะตัะตะฝะธะต, ะณะดะต ะผะพะถะฝะพ ะฟะพะปะพะถะธัั ััะพ ัะณะพะดะฝะพ ะบัะดะฐ ัะณะพะดะฝะพ. ะะธะฑะบะพ, ะฝะพ ะฝัะถะฝะพ ะฟะพะผะฝะธัั, ะณะดะต ััะพ ะปะตะถะธั, ะธ ะฟะพัะพะผ ัะฑะธัะฐัั ะทะฐ ัะพะฑะพะน.

ะ ะฟัะพะณัะฐะผะผะธัะพะฒะฐะฝะธะธ stack ะธ heap โ ััะพ ะดะฒะฐ ะพัะฝะพะฒะฝัั ัะฟะพัะพะฑะฐ ััะฐะฝะตะฝะธั ะดะฐะฝะฝัั ะฒ ะฟะฐะผััะธ. ะะพะฝะธะผะฐะฝะธะต ัะพะณะพ, ะบะฐะบ Go ัะฟัะฐะฒะปัะตั ะฟะฐะผัััั, ะบัะธัะธัะตัะบะธ ะฒะฐะถะฝะพ ะดะปั ะฝะฐะฟะธัะฐะฝะธั ัััะตะบัะธะฒะฝะพะณะพ ะบะพะดะฐ.

## Stack (ะกัะตะบ)

### ะะฐะบ ัะฐะฑะพัะฐะตั ััะตะบ

ะกัะตะบ โ ััะพ ะพะฑะปะฐััั ะฟะฐะผััะธ, ะบะพัะพัะฐั ัะฐะฑะพัะฐะตั ะฟะพ ะฟัะธะฝัะธะฟั LIFO (Last In, First Out โ ะฟะพัะปะตะดะฝะธะผ ะฟัะธัะตะป, ะฟะตัะฒัะผ ััะตะป).

```
โโโโโโโโโโโโโโโ  โ Stack pointer (ะฒะตััะธะฝะฐ)
โ   Local 3   โ
โโโโโโโโโโโโโโโค
โ   Local 2   โ
โโโโโโโโโโโโโโโค
โ   Local 1   โ
โโโโโโโโโโโโโโโค
โ   Return    โ
โโโโโโโโโโโโโโโค
โ  Function   โ
โโโโโโโโโโโโโโโ
```

**ะฅะฐัะฐะบัะตัะธััะธะบะธ ััะตะบะฐ:**
- โก ะัะตะฝั ะฑััััะพะต ะฒัะดะตะปะตะฝะธะต ะธ ะพัะฒะพะฑะพะถะดะตะฝะธะต (ะฟัะพััะพ ะดะฒะธะณะฐะตััั ัะบะฐะทะฐัะตะปั)
- ๐ ะะฐะทะผะตั ะธะทะฒะตััะตะฝ ะฝะฐ ะผะพะผะตะฝั ะบะพะผะฟะธะปััะธะธ
- ๐ ะะฒัะพะผะฐัะธัะตัะบะพะต ัะฟัะฐะฒะปะตะฝะธะต (ะฝะตั GC overhead)
- ๐ฆ ะะณัะฐะฝะธัะตะฝะฝัะน ัะฐะทะผะตั (ะพะฑััะฝะพ ะฝะตัะบะพะปัะบะพ ะะ)
- ๐งต ะะฐะถะดะฐั goroutine ะธะผะตะตั ัะฒะพะน ััะตะบ (ะฝะฐัะธะฝะฐะตััั ั 2 ะะ, ัะฐััะตั ะดะพ 1 ะะ)

### ะงัะพ ััะฐะฝะธััั ะฝะฐ ััะตะบะต

```go
func calculate() int {
    x := 10        // x ะฝะฐ ััะตะบะต
    y := 20        // y ะฝะฐ ััะตะบะต
    result := x + y // result ะฝะฐ ััะตะบะต
    return result
}

// ะะพะณะดะฐ ััะฝะบัะธั ะทะฐะฒะตััะฐะตััั, ะฒะตัั ััะตะบ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพัะธัะฐะตััั
```

**ะะฐ ััะตะบะต ััะฐะฝัััั:**
- ะะพะบะฐะปัะฝัะต ะฟะตัะตะผะตะฝะฝัะต ะฟัะธะผะธัะธะฒะฝัั ัะธะฟะพะฒ
- ะัะณัะผะตะฝัั ััะฝะบัะธะน
- ะะพะทะฒัะฐัะฐะตะผัะต ะทะฝะฐัะตะฝะธั
- ะฃะบะฐะทะฐัะตะปะธ (ัะฐะผะธ ัะบะฐะทะฐัะตะปะธ, ะฝะต ะดะฐะฝะฝัะต ะฝะฐ ะบะพัะพััะต ะพะฝะธ ัะบะฐะทัะฒะฐัั)

### ะัะธะผะตั ัะฐะฑะพัั ััะตะบะฐ

```go
func main() {           // Stack frame ะดะปั main
    x := 5              // x ะฝะฐ ััะตะบะต main
    result := add(x, 3) // ะฒัะทะพะฒ add
    fmt.Println(result)
}

func add(a, b int) int { // ะะพะฒัะน stack frame
    sum := a + b         // sum ะฝะฐ ััะตะบะต add
    return sum           // sum ะฒะพะทะฒัะฐัะฐะตััั, stack frame ัะดะฐะปัะตััั
}
```

ะะธะทัะฐะปะธะทะฐัะธั:

```
ะจะฐะณ 1: main ะฒัะทัะฒะฐะตััั
โโโโโโโโโโโโโโโโ
โ main frame   โ
โ x = 5        โ
โโโโโโโโโโโโโโโโ

ะจะฐะณ 2: add ะฒัะทัะฒะฐะตััั
โโโโโโโโโโโโโโโโ
โ add frame    โ
โ a = 5        โ
โ b = 3        โ
โ sum = 8      โ
โโโโโโโโโโโโโโโโค
โ main frame   โ
โ x = 5        โ
โโโโโโโโโโโโโโโโ

ะจะฐะณ 3: add ะทะฐะฒะตััะฐะตััั
โโโโโโโโโโโโโโโโ
โ main frame   โ
โ x = 5        โ
โ result = 8   โ
โโโโโโโโโโโโโโโโ
```

## Heap (ะััะฐ)

### ะะฐะบ ัะฐะฑะพัะฐะตั ะบััะฐ

Heap โ ััะพ ะฑะพะปััะฐั ะพะฑะปะฐััั ะฟะฐะผััะธ ะดะปั ะดะธะฝะฐะผะธัะตัะบะพะณะพ ะฒัะดะตะปะตะฝะธั. ะ ะพัะปะธัะธะต ะพั ััะตะบะฐ, ะฟะฐะผััั ะฝะฐ ะบััะต ะพััะฐะตััั ะดะพัััะฟะฝะพะน ะฟะพะบะฐ ะฝะฐ ะฝะตะต ะตััั ัััะปะบะธ.

```
Heap (ัะฐะทะดะตะปัะตะผะฐั ะผะตะถะดั ะฒัะตะผะธ goroutines)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  [Object 1]    [Object 3]           โ
โ         [Object 2]      [Object 4]  โ
โ  [Object 5]                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะฅะฐัะฐะบัะตัะธััะธะบะธ ะบััะธ:**
- ๐ ะะตะดะปะตะฝะฝะตะต ััะตะบะฐ (ััะตะฑัะตั ะฟะพะธัะบะฐ ัะฒะพะฑะพะดะฝะพะณะพ ะผะตััะฐ)
- โป๏ธ ะขัะตะฑัะตั ัะฑะพัะบะธ ะผััะพัะฐ (GC)
- ๐ ะะต ะพะณัะฐะฝะธัะตะฝะฐ ัะฐะทะผะตัะพะผ (ะฒ ะฟัะตะดะตะปะฐั ะดะพัััะฟะฝะพะน ะฟะฐะผััะธ)
- ๐ ะะฐะทะดะตะปัะตััั ะผะตะถะดั ะฒัะตะผะธ goroutines
- ๐ ะะฐะฝะฝัะต ะถะธะฒัั ะดะพ ัะตั ะฟะพั, ะฟะพะบะฐ ะฝะฐ ะฝะธั ะตััั ัััะปะบะธ

### ะงัะพ ััะฐะฝะธััั ะฝะฐ ะบััะต

```go
func createUser() *User {
    user := &User{     // user ะฒัะดะตะปัะตััั ะฝะฐ ะบััะต!
        Name: "Alice",
        Age:  30,
    }
    return user        // ะฒะพะทะฒัะฐัะฐะตะผ ัะบะฐะทะฐัะตะปั - ะดะฐะฝะฝัะต ะพััะฐัััั ะฝะฐ ะบััะต
}

// user ัััะตััะฒัะตั ะฟะพัะปะต ะทะฐะฒะตััะตะฝะธั ััะฝะบัะธะธ
// GC ัะดะฐะปะธั ะตะณะพ, ะบะพะณะดะฐ ะฝะต ะพััะฐะฝะตััั ัััะปะพะบ
```

**ะะฐ ะบััะต ััะฐะฝัััั:**
- ะะฑัะตะบัั, ะฝะฐ ะบะพัะพััะต ะฒะพะทะฒัะฐัะฐัััั ัะบะฐะทะฐัะตะปะธ
- ะกะปะฐะนัั ะธ ะผะฐะฟั (ะธั ะดะฐะฝะฝัะต, ะฝะต ัะฐะผะธ ะฟะตัะตะผะตะฝะฝัะต)
- ะะฑัะตะบัั ะฝะตะธะทะฒะตััะฝะพะณะพ ัะฐะทะผะตัะฐ ะฝะฐ ะผะพะผะตะฝั ะบะพะผะฟะธะปััะธะธ
- ะะฐะฝะฝัะต, ะบะพัะพััะต ะฝัะถะฝั ะฟะพัะปะต ะทะฐะฒะตััะตะฝะธั ััะฝะบัะธะธ
- ะะพะปััะธะต ััััะบัััั

## Escape Analysis

Escape Analysis โ ััะพ ะฟัะพัะตัั, ะบะพะณะดะฐ ะบะพะผะฟะธะปััะพั Go ัะตัะฐะตั, ะณะดะต ัะฐะทะผะตััะธัั ะฟะตัะตะผะตะฝะฝัั: ะฝะฐ ััะตะบะต ะธะปะธ ะฝะฐ ะบััะต.

### ะัะฐะฒะธะปะพ: "escapes to heap"

ะะตัะตะผะตะฝะฝะฐั "ัะฑะตะณะฐะตั" ะฝะฐ ะบััั, ะตัะปะธ:

**1. ะะพะทะฒัะฐัะฐะตััั ัะบะฐะทะฐัะตะปั ะธะท ััะฝะบัะธะธ**

```go
func createInt() *int {
    x := 42        // x ัะฑะตะณะฐะตั ะฝะฐ ะบััั
    return &x      // ะฒะพะทะฒัะฐัะฐะตะผ ัะบะฐะทะฐัะตะปั
}

// ะะฝะฐะปะธะท: x ะดะพะปะถะตะฝ ะถะธัั ะฟะพัะปะต ะทะฐะฒะตััะตะฝะธั ััะฝะบัะธะธ
// ะะตัะตะฝะธะต: ะฒัะดะตะปะธัั ะฝะฐ ะบััะต
```

**2. ะะตัะตะผะตะฝะฝะฐั ัะปะธัะบะพะผ ะฑะพะปััะฐั**

```go
func largeArray() {
    var arr [10000]int // ะกะปะธัะบะพะผ ะฑะพะปััะพะน - ะฝะฐ ะบััั
    // ...
}

// ะะฝะฐะปะธะท: ัะฐะทะผะตั ะฟัะตะฒััะฐะตั ัะฐะทัะผะฝัะน ะดะปั ััะตะบะฐ
// ะะตัะตะฝะธะต: ะฒัะดะตะปะธัั ะฝะฐ ะบััะต
```

**3. ะะฐะทะผะตั ะฝะตะธะทะฒะตััะตะฝ ะฝะฐ ะผะพะผะตะฝั ะบะพะผะฟะธะปััะธะธ**

```go
func dynamicSlice(n int) []int {
    slice := make([]int, n) // n ะฝะตะธะทะฒะตััะตะฝ - ะดะฐะฝะฝัะต ะฝะฐ ะบััั
    return slice
}
```

**4. ะะตัะตะผะตะฝะฝะฐั ะดะพัััะฟะฝะฐ ะธะท ะทะฐะผัะบะฐะฝะธั**

```go
func makeCounter() func() int {
    count := 0  // count ัะฑะตะณะฐะตั ะฝะฐ ะบััั
    return func() int {
        count++
        return count
    }
}

// ะะฝะฐะปะธะท: count ะธัะฟะพะปัะทัะตััั ะฒ ะทะฐะผัะบะฐะฝะธะธ
// ะะตัะตะฝะธะต: ะฒัะดะตะปะธัั ะฝะฐ ะบััะต
```

**5. ะฅัะฐะฝะธััั ะฒ ะธะฝัะตััะตะนัะต**

```go
func storeInInterface() interface{} {
    x := 42           // x ัะฑะตะณะฐะตั ะฝะฐ ะบััั
    return interface{}(x)
}

// ะะฝะฐะปะธะท: ะธะฝัะตััะตะนั ะผะพะถะตั ััะฐะฝะธัั ััะพ ัะณะพะดะฝะพ
// ะะตัะตะฝะธะต: ะฒัะดะตะปะธัั ะฝะฐ ะบััะต
```

### ะะฐะบ ะฟัะพะฒะตัะธัั Escape Analysis

ะัะฟะพะปัะทัะนัะต ัะปะฐะณ ะบะพะผะฟะธะปััะพัะฐ `-gcflags`:

```bash
go build -gcflags="-m" main.go
```

ะัะธะผะตั:

```go
package main

type User struct {
    Name string
    Age  int
}

func createOnStack() User {
    return User{Name: "Alice", Age: 30}
}

func createOnHeap() *User {
    return &User{Name: "Bob", Age: 25}
}

func main() {
    u1 := createOnStack()
    u2 := createOnHeap()
    _, _ = u1, u2
}
```

ะะตะทัะปััะฐั ะฐะฝะฐะปะธะทะฐ:

```bash
$ go build -gcflags="-m -m" main.go

./main.go:9:9: User{...} does not escape
./main.go:13:9: &User{...} escapes to heap
./main.go:13:9:   flow: ~r0 = &{storage for &User{...}}
./main.go:13:10: User{...} escapes to heap
```

## Stack vs Heap: ะัะธะผะตัั

### ะัะธะผะตั 1: ะะพะบะฐะปัะฝัะต ะฟะตัะตะผะตะฝะฝัะต

```go
func example1() {
    // ะัะต ะฝะฐ ััะตะบะต - ะฑััััะพ ะธ ัััะตะบัะธะฒะฝะพ
    x := 10
    y := 20
    z := x + y
    fmt.Println(z)
}
```

### ะัะธะผะตั 2: ะะพะทะฒัะฐั ะทะฝะฐัะตะฝะธั

```go
func example2() User {
    // User ะฒะพะทะฒัะฐัะฐะตััั ะฟะพ ะทะฝะฐัะตะฝะธั - ะฝะฐ ััะตะบะต
    return User{Name: "Alice", Age: 30}
}

func example3() *User {
    // User ะฒะพะทะฒัะฐัะฐะตััั ะฟะพ ัะบะฐะทะฐัะตะปั - ะฝะฐ ะบััะต
    return &User{Name: "Bob", Age: 25}
}
```

### ะัะธะผะตั 3: ะกะปะฐะนัั

```go
func example4() {
    // ะะตัะตะผะตะฝะฝะฐั slice ะฝะฐ ััะตะบะต
    // ะะพ ะดะฐะฝะฝัะต ัะปะฐะนัะฐ ะฝะฐ ะบััะต
    slice := []int{1, 2, 3, 4, 5}
    
    // Header ัะปะฐะนัะฐ (ptr, len, cap) - ะฝะฐ ััะตะบะต
    // ะะฐััะธะฒ ะดะฐะฝะฝัั [1,2,3,4,5] - ะฝะฐ ะบััะต
    _ = slice
}
```

ะะธะทัะฐะปะธะทะฐัะธั:

```
Stack:
โโโโโโโโโโโโโโโโโโโ
โ slice header:   โ
โ   ptr    โโโโโโโโผโโ
โ   len = 5       โ โ
โ   cap = 5       โ โ
โโโโโโโโโโโโโโโโโโโ โ
                    โ
Heap:               โ
โโโโโโโโโโโโโโโโโโโโโผโโโโ
โ [1][2][3][4][5]       โ
โโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะัะธะผะตั 4: ะะฐะผัะบะฐะฝะธั

```go
func example5() func() int {
    count := 0 // count ะฝะฐ ะบััะต (escape analysis)
    
    return func() int {
        count++ // ะธัะฟะพะปัะทัะตััั ะฟะพัะปะต ะทะฐะฒะตััะตะฝะธั example5
        return count
    }
}

func main() {
    counter := example5()
    fmt.Println(counter()) // 1
    fmt.Println(counter()) // 2
    fmt.Println(counter()) // 3
}
```

## ะะฟัะธะผะธะทะฐัะธั: ะฟัะตะดะพัะฒัะฐัะตะฝะธะต escape

### ะขะตัะฝะธะบะฐ 1: ะะพะทะฒัะฐัะฐะนัะต ะทะฝะฐัะตะฝะธั, ะฐ ะฝะต ัะบะฐะทะฐัะตะปะธ

```go
// ะะตะดะปะตะฝะฝะตะต - ะฐะปะปะพะบะฐัะธั ะฝะฐ ะบััะต
func createUserBad() *User {
    return &User{Name: "Alice"}
}

// ะััััะตะต - ะฝะฐ ััะตะบะต
func createUserGood() User {
    return User{Name: "Alice"}
}
```

**ะะพะณะดะฐ ััะพ ัะฐะฑะพัะฐะตั:**
- ะกัััะบัััะฐ ะฝะตะฑะพะปััะฐั (< 10 ะฟะพะปะตะน)
- ะะต ะฝัะถะฝะพ ะธะทะผะตะฝััั ะพัะธะณะธะฝะฐะป
- ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั ะบัะธัะธัะฝะฐ

### ะขะตัะฝะธะบะฐ 2: ะัะฟะพะปัะทัะนัะต sync.Pool ะดะปั ะฟะตัะตะธัะฟะพะปัะทะพะฒะฐะฝะธั

```go
var userPool = sync.Pool{
    New: func() interface{} {
        return &User{}
    },
}

func processUser(name string, age int) {
    // ะะตัะตะผ ะธะท ะฟัะปะฐ ะฒะผะตััะพ ะฐะปะปะพะบะฐัะธะธ
    user := userPool.Get().(*User)
    user.Name = name
    user.Age = age
    
    // ะะฐะฑะพัะฐะตะผ ั user...
    
    // ะะพะทะฒัะฐัะฐะตะผ ะฒ ะฟัะป
    userPool.Put(user)
}
```

### ะขะตัะฝะธะบะฐ 3: ะัะตะดะฒัะดะตะปัะนัะต ัะปะฐะนัั

```go
// ะะปะพัะพ - ะผะฝะพะถะตััะฒะพ ะฐะปะปะพะบะฐัะธะน
func collectBad() []int {
    var result []int
    for i := 0; i < 1000; i++ {
        result = append(result, i) // ัะตะฐะปะปะพะบะฐัะธะธ
    }
    return result
}

// ะฅะพัะพัะพ - ะพะดะฝะฐ ะฐะปะปะพะบะฐัะธั
func collectGood() []int {
    result := make([]int, 0, 1000) // ะฟัะตะดะฒัะดะตะปะธะปะธ capacity
    for i := 0; i < 1000; i++ {
        result = append(result, i)
    }
    return result
}
```

### ะขะตัะฝะธะบะฐ 4: ะะทะฑะตะณะฐะนัะต ะธะฝัะตััะตะนัะพะฒ ะดะปั ะฟัะธะผะธัะธะฒะพะฒ

```go
// ะะปะพัะพ - int boxing ะฝะฐ ะบััั
func sumBad(values []interface{}) int {
    sum := 0
    for _, v := range values {
        sum += v.(int) // boxing/unboxing
    }
    return sum
}

// ะฅะพัะพัะพ - ะฝะฐัะธะฒะฝัะน ัะธะฟ
func sumGood(values []int) int {
    sum := 0
    for _, v := range values {
        sum += v
    }
    return sum
}
```

## Memory Model

Go Memory Model ะพะฟัะตะดะตะปัะตั ะฟัะฐะฒะธะปะฐ ะฒะธะดะธะผะพััะธ ะธะทะผะตะฝะตะฝะธะน ะฟะฐะผััะธ ะผะตะถะดั goroutines.

### Happens-Before ะพัะฝะพัะตะฝะธะต

ะกะพะฑััะธะต A "happens-before" ัะพะฑััะธั B ะพะทะฝะฐัะฐะตั, ััะพ ะธะทะผะตะฝะตะฝะธั, ัะดะตะปะฐะฝะฝัะต ะดะพ A, ะฒะธะดะฝั ะฟะพัะปะต B.

### ะัะฐะฒะธะปะพ 1: ะะฝะธัะธะฐะปะธะทะฐัะธั

```go
var a string

func init() {
    a = "hello" // happens-before main
}

func main() {
    fmt.Println(a) // ะณะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพ ัะฒะธะดะธั "hello"
}
```

### ะัะฐะฒะธะปะพ 2: Goroutine creation

```go
var message string

func main() {
    message = "hello"
    
    go func() {
        // ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพ ัะฒะธะดะธั message = "hello"
        // ะฟะพัะพะผั ััะพ ะฟัะธัะฒะฐะธะฒะฐะฝะธะต happens-before go statement
        fmt.Println(message)
    }()
    
    time.Sleep(time.Second)
}
```

### ะัะฐะฒะธะปะพ 3: Channel operations

```go
var c = make(chan int)
var message string

func main() {
    go func() {
        message = "hello" // 1. ะัะธัะฒะฐะธะฒะฐะฝะธะต
        c <- 1            // 2. ะัะฟัะฐะฒะบะฐ ะฒ ะบะฐะฝะฐะป
    }()
    
    <-c                   // 3. ะะพะปััะตะฝะธะต ะธะท ะบะฐะฝะฐะปะฐ
    fmt.Println(message)  // 4. ะงัะตะฝะธะต
    
    // 1 happens-before 2
    // 2 happens-before 3 (channel synchronization)
    // 3 happens-before 4
    // ะกะปะตะดะพะฒะฐัะตะปัะฝะพ: 1 happens-before 4
    // ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพ ัะฒะธะดะธะผ "hello"
}
```

### ะัะฐะฒะธะปะพ 4: Mutex

```go
var mu sync.Mutex
var data int

func write() {
    mu.Lock()
    data = 42     // happens-before Unlock
    mu.Unlock()
}

func read() {
    mu.Lock()     // happens-after ะปัะฑะพะน ะฟัะตะดัะดััะธะน Unlock
    fmt.Println(data)
    mu.Unlock()
}
```

### ะะฟะฐัะฝัะน ะบะพะด ะฑะตะท ัะธะฝััะพะฝะธะทะฐัะธะธ

```go
var data int
var ready bool

// Goroutine 1
func writer() {
    data = 42    // ะะพะถะตั ะฑััั ะฟะตัะตัะฟะพััะดะพัะตะฝะพ!
    ready = true
}

// Goroutine 2
func reader() {
    for !ready { // ะะพะถะตั ะฝะต ัะฒะธะดะตัั ready = true
        // spin
    }
    fmt.Println(data) // ะะพะถะตั ัะฒะธะดะตัั data = 0 !!!
}
```

**ะัะพะฑะปะตะผะฐ:** ะบะพะผะฟะธะปััะพั ะธ ะฟัะพัะตััะพั ะผะพะณัั ะฟะตัะตัะฟะพััะดะพัะธัั ะพะฟะตัะฐัะธะธ!

**ะะตัะตะฝะธะต:** ะธัะฟะพะปัะทัะนัะต ัะธะฝััะพะฝะธะทะฐัะธั:

```go
var data int
var mu sync.Mutex

func writer() {
    mu.Lock()
    data = 42
    mu.Unlock()
}

func reader() {
    mu.Lock()
    fmt.Println(data) // ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพ ะฒะธะดะธั ะบะพััะตะบัะฝะพะต ะทะฝะฐัะตะฝะธะต
    mu.Unlock()
}
```

## Data Race

Data Race ะฒะพะทะฝะธะบะฐะตั, ะบะพะณะดะฐ:
1. ะะฒะต goroutines ะพะฑัะฐัะฐัััั ะบ ะพะดะฝะพะน ะฟะตัะตะผะตะฝะฝะพะน
2. ะฅะพัั ะฑั ะพะดะธะฝ ะดะพัััะฟ โ ะทะฐะฟะธัั
3. ะะตั ัะธะฝััะพะฝะธะทะฐัะธะธ ะผะตะถะดั ะดะพัััะฟะฐะผะธ

### ะัะธะผะตั Data Race

```go
package main

import "fmt"

func main() {
    counter := 0
    
    // ะะฐะฟััะบะฐะตะผ 1000 goroutines
    for i := 0; i < 1000; i++ {
        go func() {
            counter++ // DATA RACE!
        }()
    }
    
    time.Sleep(time.Second)
    fmt.Println(counter) // ะะตะฟัะตะดัะบะฐะทัะตะผัะน ัะตะทัะปััะฐั
}
```

### ะะฑะฝะฐััะถะตะฝะธะต Data Race

```bash
go run -race main.go
```

ะัะฒะพะด:

```
==================
WARNING: DATA RACE
Write at 0x00c000018090 by goroutine 7:
  main.main.func1()
      /path/main.go:10 +0x3e

Previous write at 0x00c000018090 by goroutine 6:
  main.main.func1()
      /path/main.go:10 +0x3e
==================
```

### ะัะฟัะฐะฒะปะตะฝะธะต Data Race

**ะะฐัะธะฐะฝั 1: Mutex**

```go
var counter int
var mu sync.Mutex

for i := 0; i < 1000; i++ {
    go func() {
        mu.Lock()
        counter++
        mu.Unlock()
    }()
}
```

**ะะฐัะธะฐะฝั 2: Atomic ะพะฟะตัะฐัะธะธ**

```go
var counter int64

for i := 0; i < 1000; i++ {
    go func() {
        atomic.AddInt64(&counter, 1)
    }()
}
```

**ะะฐัะธะฐะฝั 3: Channel**

```go
done := make(chan bool)
counter := 0

go func() {
    for range done {
        counter++
    }
}()

for i := 0; i < 1000; i++ {
    done <- true
}
```

## ะัะฐะบัะธัะตัะบะธะต ัะพะฒะตัั

### 1. ะัะพัะธะปะธััะนัะต ะฐะปะปะพะบะฐัะธะธ

```go
import "testing"

func BenchmarkExample(b *testing.B) {
    b.ReportAllocs() // ะะพะบะฐะถะตั ะบะพะปะธัะตััะฒะพ ะฐะปะปะพะบะฐัะธะน
    
    for i := 0; i < b.N; i++ {
        // ะฒะฐั ะบะพะด
    }
}
```

ะะฐะฟััะบ:

```bash
go test -bench=. -benchmem
```

### 2. ะัะฟะพะปัะทัะนัะต pprof ะดะปั ะฐะฝะฐะปะธะทะฐ heap

```go
import _ "net/http/pprof"

func main() {
    go func() {
        http.ListenAndServe("localhost:6060", nil)
    }()
    
    // ะฒะฐั ะบะพะด
}
```

ะะฝะฐะปะธะท:

```bash
go tool pprof http://localhost:6060/debug/pprof/heap
```

### 3. ะะพะฝะธัะพัััะต ัะฐะทะผะตั ััะตะบะฐ goroutines

```go
import "runtime/debug"

func main() {
    debug.SetMaxStack(1024 * 1024 * 100) // 100 ะะ ะฝะฐ goroutine
}
```

### 4. ะัะฟะพะปัะทัะนัะต ะธะฝะปะฐะนะฝะธะฝะณ

ะะพะผะฟะธะปััะพั ะผะพะถะตั ะฒัััะพะธัั ะผะฐะปะตะฝัะบะธะต ััะฝะบัะธะธ, ะธะทะฑะตะณะฐั ัะพะทะดะฐะฝะธั stack frame:

```go
//go:inline
func add(a, b int) int {
    return a + b
}
```

## ะงะตะบ-ะปะธัั ะพะฟัะธะผะธะทะฐัะธะธ ะฟะฐะผััะธ

โ **ะะพะทะฒัะฐัะฐะนัะต ะทะฝะฐัะตะฝะธั ะฒะผะตััะพ ัะบะฐะทะฐัะตะปะตะน** ะดะปั ะผะฐะปะตะฝัะบะธั ััััะบััั
โ **ะัะตะดะฒัะดะตะปัะนัะต ัะปะฐะนัั** ั ะธะทะฒะตััะฝัะผ capacity
โ **ะัะฟะพะปัะทัะนัะต sync.Pool** ะดะปั ัะฐััะพ ัะพะทะดะฐะฒะฐะตะผัั ะพะฑัะตะบัะพะฒ
โ **ะะทะฑะตะณะฐะนัะต ะธะฝัะตััะตะนัะพะฒ** ะดะปั ะฟัะธะผะธัะธะฒะพะฒ ะฒ ะณะพัััะธั ะฟัััั
โ **ะัะพะฒะตััะนัะต escape analysis** ั `-gcflags="-m"`
โ **ะัะฟะพะปัะทัะนัะต race detector** ะฒ ัะฐะทัะฐะฑะพัะบะต
โ **ะัะพัะธะปะธััะนัะต** ั ะฟะพะผะพััั pprof
โ **ะะทะฑะตะณะฐะนัะต ะณะปะพะฑะฐะปัะฝัั ะฟะตัะตะผะตะฝะฝัั** ั ัะบะฐะทะฐัะตะปัะผะธ (ะพะฝะธ ะฒัะตะณะดะฐ ะฝะฐ ะบััะต)

## ะะฐะบะปััะตะฝะธะต

ะะพะฝะธะผะฐะฝะธะต ัะฐะฑะพัั ะฟะฐะผััะธ ะฒ Go ะบัะธัะธัะฝะพ ะดะปั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ:

**Stack:**
- ะัััััะน, ะฐะฒัะพะผะฐัะธัะตัะบะธะน
- ะะณัะฐะฝะธัะตะฝ ัะฐะทะผะตัะพะผ
- ะะดะตะฐะปะตะฝ ะดะปั ะปะพะบะฐะปัะฝัั ะฟะตัะตะผะตะฝะฝัั

**Heap:**
- ะะธะฑะบะธะน, ะฑะพะปััะพะน
- ะขัะตะฑัะตั GC
- ะัะฟะพะปัะทัะตััั ะดะปั ะดะฐะฝะฝัั ั ะฝะตะธะทะฒะตััะฝัะผ ะฒัะตะผะตะฝะตะผ ะถะธะทะฝะธ

**Escape Analysis:**
- ะะพะผะฟะธะปััะพั ัะตัะฐะตั ะฐะฒัะพะผะฐัะธัะตัะบะธ
- ะะพะถะฝะพ ะพะฟัะธะผะธะทะธัะพะฒะฐัั, ะฟะพะฝะธะผะฐั ะฟัะฐะฒะธะปะฐ
- ะัะพะฒะตััะนัะต ั `-gcflags="-m"`

**Memory Model:**
- ะะฟัะตะดะตะปัะตั ะฒะธะดะธะผะพััั ะผะตะถะดั goroutines
- ะัะฟะพะปัะทัะนัะต ัะธะฝััะพะฝะธะทะฐัะธั (mutex, channels, atomic)
- ะัะตะณะดะฐ ะธัะฟะพะปัะทัะนัะต race detector

**ะะพะปะพัะพะต ะฟัะฐะฒะธะปะพ:** ะฟะธัะธัะต ัะฝะฐัะฐะปะฐ ะฟัะพััะพะน ะธ ะฟะพะฝััะฝัะน ะบะพะด, ะฟะพัะพะผ ะฟัะพัะธะปะธััะนัะต ะธ ะพะฟัะธะผะธะทะธััะนัะต ัะทะบะธะต ะผะตััะฐ!